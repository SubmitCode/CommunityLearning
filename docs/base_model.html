---

title: Base model

keywords: fastai
sidebar: home_sidebar

summary: "Dieses Modul stellt die Wesentlichen Funktionen für Training, Prediction und Evaluation bereit. "
description: "Dieses Modul stellt die Wesentlichen Funktionen für Training, Prediction und Evaluation bereit. "
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 04_base_model.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autotime
<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 333 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 7.02 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="load_data" class="doc_header"><code>load_data</code><a href="https://github.com/submitCode/community_learning/tree/master/community_learning/base_model.py#L18" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>load_data</code>(<strong><code>path_train</code></strong>=<em><code>'data/interim/03_train.csv'</code></em>, <strong><code>path_test</code></strong>=<em><code>'data/interim/03_test.csv'</code></em>)</p>
</blockquote>
<p>load data</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_org</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">()</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">train_org</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 2.35 s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Train---Test-Split">Train - Test Split<a class="anchor-link" href="#Train---Test-Split"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 16 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_shift_cols" class="doc_header"><code>get_shift_cols</code><a href="https://github.com/submitCode/community_learning/tree/master/community_learning/base_model.py#L27" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_shift_cols</code>(<strong><code>columns</code></strong>:<code>list</code>)</p>
</blockquote>
<p>get a list of columns</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">shift_cols</span> <span class="o">=</span> <span class="n">get_shift_cols</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shift_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 8.11 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 7.87 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">target_cols</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>24</pre>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 10.8 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 10.4 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_product_dict" class="doc_header"><code>get_product_dict</code><a href="https://github.com/submitCode/community_learning/tree/master/community_learning/base_model.py#L59" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_product_dict</code>(<strong><code>df</code></strong>:<code>DataFrame</code>)</p>
</blockquote>
<p>returns product_name: integer pairs</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_product_reverse_dict" class="doc_header"><code>get_product_reverse_dict</code><a href="https://github.com/submitCode/community_learning/tree/master/community_learning/base_model.py#L64" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_product_reverse_dict</code>(<strong><code>df</code></strong>:<code>DataFrame</code>)</p>
</blockquote>
<p>returns product_name: integer pairs</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">product_dict</span> <span class="o">=</span> <span class="n">get_product_dict</span><span class="p">(</span><span class="n">train_org</span><span class="p">)</span>
<span class="n">product_reverse_dict</span> <span class="o">=</span> <span class="n">get_product_reverse_dict</span><span class="p">(</span><span class="n">train_org</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="kc">True</span>  <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">product_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">product_reverse_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())])</span>
<span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">product_dict</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span>
<span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">product_reverse_dict</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span>
<span class="n">product_dict</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;ind_cco_fin_ult1&#39;: 0,
 &#39;ind_cder_fin_ult1&#39;: 1,
 &#39;ind_cno_fin_ult1&#39;: 2,
 &#39;ind_ctju_fin_ult1&#39;: 3,
 &#39;ind_ctma_fin_ult1&#39;: 4,
 &#39;ind_ctop_fin_ult1&#39;: 5,
 &#39;ind_ctpp_fin_ult1&#39;: 6,
 &#39;ind_deco_fin_ult1&#39;: 7,
 &#39;ind_dela_fin_ult1&#39;: 8,
 &#39;ind_deme_fin_ult1&#39;: 9,
 &#39;ind_ecue_fin_ult1&#39;: 10,
 &#39;ind_fond_fin_ult1&#39;: 11,
 &#39;ind_hip_fin_ult1&#39;: 12,
 &#39;ind_nom_pens_ult1&#39;: 13,
 &#39;ind_nomina_ult1&#39;: 14,
 &#39;ind_plan_fin_ult1&#39;: 15,
 &#39;ind_pres_fin_ult1&#39;: 16,
 &#39;ind_reca_fin_ult1&#39;: 17,
 &#39;ind_recibo_ult1&#39;: 18,
 &#39;ind_tjcr_fin_ult1&#39;: 19,
 &#39;ind_valo_fin_ult1&#39;: 20,
 &#39;ind_viv_fin_ult1&#39;: 21}</pre>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 46.1 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">get_product_reverse_dict</span><span class="p">(</span><span class="n">train_org</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{0: &#39;ind_cco_fin_ult1&#39;,
 1: &#39;ind_cder_fin_ult1&#39;,
 2: &#39;ind_cno_fin_ult1&#39;,
 3: &#39;ind_ctju_fin_ult1&#39;,
 4: &#39;ind_ctma_fin_ult1&#39;,
 5: &#39;ind_ctop_fin_ult1&#39;,
 6: &#39;ind_ctpp_fin_ult1&#39;,
 7: &#39;ind_deco_fin_ult1&#39;,
 8: &#39;ind_dela_fin_ult1&#39;,
 9: &#39;ind_deme_fin_ult1&#39;,
 10: &#39;ind_ecue_fin_ult1&#39;,
 11: &#39;ind_fond_fin_ult1&#39;,
 12: &#39;ind_hip_fin_ult1&#39;,
 13: &#39;ind_nom_pens_ult1&#39;,
 14: &#39;ind_nomina_ult1&#39;,
 15: &#39;ind_plan_fin_ult1&#39;,
 16: &#39;ind_pres_fin_ult1&#39;,
 17: &#39;ind_reca_fin_ult1&#39;,
 18: &#39;ind_recibo_ult1&#39;,
 19: &#39;ind_tjcr_fin_ult1&#39;,
 20: &#39;ind_valo_fin_ult1&#39;,
 21: &#39;ind_viv_fin_ult1&#39;}</pre>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 21.9 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 7.26 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="encode_products" class="doc_header"><code>encode_products</code><a href="https://github.com/submitCode/community_learning/tree/master/community_learning/base_model.py#L71" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>encode_products</code>(<strong><code>df</code></strong>:<code>DataFrame</code>)</p>
</blockquote>
<p>encode products with integer</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train</span> <span class="o">=</span> <span class="n">encode_products</span><span class="p">(</span><span class="n">train_org</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 114 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 7.21 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="x_y_split" class="doc_header"><code>x_y_split</code><a href="https://github.com/submitCode/community_learning/tree/master/community_learning/base_model.py#L78" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>x_y_split</code>(<strong><code>df</code></strong>:<code>DataFrame</code>)</p>
</blockquote>
<p>returns 2 dataframes for X and Y variables</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_X</span><span class="p">,</span> <span class="n">train_y</span> <span class="o">=</span> <span class="n">x_y_split</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="k">assert</span> <span class="s1">&#39;y&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">train_X</span><span class="o">.</span><span class="n">columns</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 24.8 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="XGB-train">XGB train<a class="anchor-link" href="#XGB-train"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 7.95 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="runXGB" class="doc_header"><code>runXGB</code><a href="https://github.com/submitCode/community_learning/tree/master/community_learning/base_model.py#L85" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>runXGB</code>(<strong><code>train_X</code></strong>, <strong><code>train_y</code></strong>, <strong><code>feature_cols</code></strong>, <strong><code>seed_val</code></strong>=<em><code>0</code></em>, <strong><code>use_gpu</code></strong>=<em><code>False</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">runXGB</span><span class="p">(</span><span class="n">train_X</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">==</span> <span class="n">xgb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Booster</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 37.3 s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Evaluate">Evaluate<a class="anchor-link" href="#Evaluate"> </a></h2><p>Für die <a href="https://www.kaggle.com/c/santander-product-recommendation/overview/evaluation">Evaluierung</a> wird der Mean Average Precision @ 7 (MAP@7) hergenommen. Die unten stehenden Formel haben wir uns von <a href="https://github.com/jturkewitz/SideProjects/blob/4c437b02d5e017636c84cc22eb3ff71f8eea1308/Kaggle/Santander_Prod/santander_prod.py#L272">jturkewitz</a> ausgeliehen. <a href="http://sdsawtelle.github.io/blog/output/mean-average-precision-MAP-for-recommender-systems.html">Hier</a> noch eine gute Erklärung.</p>
$$
MAP@7 =  \dfrac{1} {\vert U \vert} \sum^{\vert U \vert}_{u=1} \dfrac {1} {min(m,7)} \sum^{min(n,7)}_{k=1} P(k)
$$
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 9.91 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="apk" class="doc_header"><code>apk</code><a href="https://github.com/submitCode/community_learning/tree/master/community_learning/base_model.py#L109" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>apk</code>(<strong><code>actual</code></strong>, <strong><code>predicted</code></strong>, <strong><code>k</code></strong>=<em><code>7</code></em>)</p>
</blockquote>
<p>Computes the average precision at k.
This function computes the average prescision at k between two lists of
items.</p>
<h2 id="Parameters">Parameters<a class="anchor-link" href="#Parameters"> </a></h2><p>actual : list
         A list of elements that are to be predicted (order doesn't matter)
predicted : list
            A list of predicted elements (order does matter)
k : int, optional
    The maximum number of predicted elements</p>
<h2 id="Returns">Returns<a class="anchor-link" href="#Returns"> </a></h2><p>score : double
        The average precision at k over the input lists</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">xgtest</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">DMatrix</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">])</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">xgtest</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">preds</span><span class="p">)[:,:</span><span class="mi">7</span><span class="p">]</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">product_reverse_dict</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
<span class="n">preds</span><span class="p">[</span><span class="s1">&#39;added_products&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="s1">&#39;added_products&#39;</span><span class="p">]</span>
<span class="n">preds</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0         [ind_recibo_ult1, ind_tjcr_fin_ult1, ind_fond_...
1         [ind_cco_fin_ult1, ind_dela_fin_ult1, ind_reca...
2         [ind_nom_pens_ult1, ind_nomina_ult1, ind_ctop_...
3         [ind_cco_fin_ult1, ind_tjcr_fin_ult1, ind_reci...
4         [ind_cno_fin_ult1, ind_fond_fin_ult1, ind_valo...
                                ...                        
702430    [ind_nom_pens_ult1, ind_nomina_ult1, ind_recib...
702431    [ind_recibo_ult1, ind_nomina_ult1, ind_nom_pen...
702432    [ind_recibo_ult1, ind_nomina_ult1, ind_cno_fin...
702433    [ind_cco_fin_ult1, ind_recibo_ult1, ind_ecue_f...
702434    [ind_recibo_ult1, ind_cno_fin_ult1, ind_nomina...
Name: added_products, Length: 702435, dtype: object</pre>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 40.5 s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;added_products&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span>
<span class="n">test</span><span class="p">[</span><span class="s1">&#39;truth_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">target_cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="n">target_cols</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test</span><span class="p">[[</span><span class="s1">&#39;added_products&#39;</span><span class="p">,</span> <span class="s1">&#39;truth_list&#39;</span><span class="p">]]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>added_products</th>
      <th>truth_list</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>[ind_recibo_ult1, ind_tjcr_fin_ult1, ind_fond_...</td>
      <td>[ind_tjcr_fin_ult1]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>[ind_cco_fin_ult1, ind_dela_fin_ult1, ind_reca...</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>[ind_nom_pens_ult1, ind_nomina_ult1, ind_ctop_...</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>[ind_cco_fin_ult1, ind_tjcr_fin_ult1, ind_reci...</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>[ind_cno_fin_ult1, ind_fond_fin_ult1, ind_valo...</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>702430</th>
      <td>[ind_nom_pens_ult1, ind_nomina_ult1, ind_recib...</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>702431</th>
      <td>[ind_recibo_ult1, ind_nomina_ult1, ind_nom_pen...</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>702432</th>
      <td>[ind_recibo_ult1, ind_nomina_ult1, ind_cno_fin...</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>702433</th>
      <td>[ind_cco_fin_ult1, ind_recibo_ult1, ind_ecue_f...</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>702434</th>
      <td>[ind_recibo_ult1, ind_cno_fin_ult1, ind_nomina...</td>
      <td>[]</td>
    </tr>
  </tbody>
</table>
<p>702435 rows × 2 columns</p>
</div>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 2.67 s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;apk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">apk</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;truth_list&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;added_products&#39;</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mean average precision = </span><span class="si">{</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;apk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>mean average precision = 0.022998457293851166
time: 15.8 s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test</span><span class="p">[[</span><span class="s1">&#39;added_products&#39;</span><span class="p">,</span> <span class="s1">&#39;truth_list&#39;</span><span class="p">,</span> <span class="s1">&#39;apk&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>added_products</th>
      <th>truth_list</th>
      <th>apk</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>[ind_recibo_ult1, ind_tjcr_fin_ult1, ind_fond_...</td>
      <td>[ind_tjcr_fin_ult1]</td>
      <td>0.5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>[ind_cco_fin_ult1, ind_dela_fin_ult1, ind_reca...</td>
      <td>[]</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>[ind_nom_pens_ult1, ind_nomina_ult1, ind_ctop_...</td>
      <td>[]</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>[ind_cco_fin_ult1, ind_tjcr_fin_ult1, ind_reci...</td>
      <td>[]</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>[ind_cno_fin_ult1, ind_fond_fin_ult1, ind_valo...</td>
      <td>[]</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>95</th>
      <td>[ind_cco_fin_ult1, ind_tjcr_fin_ult1, ind_reci...</td>
      <td>[]</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>96</th>
      <td>[ind_tjcr_fin_ult1, ind_ecue_fin_ult1, ind_rec...</td>
      <td>[]</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>97</th>
      <td>[ind_nom_pens_ult1, ind_nomina_ult1, ind_cno_f...</td>
      <td>[]</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>98</th>
      <td>[ind_cno_fin_ult1, ind_valo_fin_ult1, ind_ctop...</td>
      <td>[]</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>99</th>
      <td>[ind_tjcr_fin_ult1, ind_nom_pens_ult1, ind_nom...</td>
      <td>[ind_tjcr_fin_ult1]</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>100 rows × 3 columns</p>
</div>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 32.4 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 8.17 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_results" class="doc_header"><code>get_results</code><a href="https://github.com/submitCode/community_learning/tree/master/community_learning/base_model.py#L145" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_results</code>(<strong><code>test_data</code></strong>:<code>DataFrame</code>, <strong><code>model</code></strong>:<code>Booster</code>, <strong><code>product_reverse_dict</code></strong>:<code>list</code>, <strong><code>feature_cols</code></strong>:<code>list</code>=<em><code>['ind_empleado', 'sexo', 'age', 'renta', 'ind_nuevo', 'indrel', 'indrel_1mes', 'tiprel_1mes', 'indresi', 'indext', 'conyuemp', 'indfall', 'tipodom', 'ind_actividad_cliente', 'segmento', 'antiguedad', 'pais_residencia', 'canal_entrada', 'ind_cco_fin_ult1_s', 'ind_cder_fin_ult1_s', 'ind_cno_fin_ult1_s', 'ind_ctju_fin_ult1_s', 'ind_ctma_fin_ult1_s', 'ind_ctop_fin_ult1_s', 'ind_ctpp_fin_ult1_s', 'ind_deco_fin_ult1_s', 'ind_deme_fin_ult1_s', 'ind_dela_fin_ult1_s', 'ind_ecue_fin_ult1_s', 'ind_fond_fin_ult1_s', 'ind_hip_fin_ult1_s', 'ind_plan_fin_ult1_s', 'ind_pres_fin_ult1_s', 'ind_reca_fin_ult1_s', 'ind_tjcr_fin_ult1_s', 'ind_valo_fin_ult1_s', 'ind_viv_fin_ult1_s', 'ind_nomina_ult1_s', 'ind_nom_pens_ult1_s', 'ind_recibo_ult1_s']</code></em>, <strong><code>target_cols</code></strong>:<code>list</code>=<em><code>['ind_ahor_fin_ult1', 'ind_aval_fin_ult1', 'ind_cco_fin_ult1', 'ind_cder_fin_ult1', 'ind_cno_fin_ult1', 'ind_ctju_fin_ult1', 'ind_ctma_fin_ult1', 'ind_ctop_fin_ult1', 'ind_ctpp_fin_ult1', 'ind_deco_fin_ult1', 'ind_deme_fin_ult1', 'ind_dela_fin_ult1', 'ind_ecue_fin_ult1', 'ind_fond_fin_ult1', 'ind_hip_fin_ult1', 'ind_plan_fin_ult1', 'ind_pres_fin_ult1', 'ind_reca_fin_ult1', 'ind_tjcr_fin_ult1', 'ind_valo_fin_ult1', 'ind_viv_fin_ult1', 'ind_nomina_ult1', 'ind_nom_pens_ult1', 'ind_recibo_ult1']</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">get_results</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">target_cols</span><span class="p">)</span>
<span class="k">assert</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">results</span>
<span class="k">assert</span> <span class="s1">&#39;truth_list&#39;</span> <span class="ow">in</span> <span class="n">results</span>
<span class="k">assert</span> <span class="s1">&#39;apk&#39;</span> <span class="ow">in</span> <span class="n">results</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>mean average precision = 0.003241901668357498
time: 1min 16s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Main-function">Main function<a class="anchor-link" href="#Main-function"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 100 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_base_model_results" class="doc_header"><code>get_base_model_results</code><a href="https://github.com/submitCode/community_learning/tree/master/community_learning/base_model.py#L169" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_base_model_results</code>(<strong><code>source_train</code></strong>:"source csv file for train"=<em><code>'data/interim/03_train.csv'</code></em>, <strong><code>source_test</code></strong>:"source csv file for test"=<em><code>'data/interim/03_test.csv'</code></em>, <strong><code>dest</code></strong>:"destination csv file for the results"=<em><code>'data/results/base_model.csv'</code></em>, <strong><code>feature_cols</code></strong>:"list of features to use for training"=<em><code>['ind_empleado', 'sexo', 'age', 'renta', 'ind_nuevo', 'indrel', 'indrel_1mes', 'tiprel_1mes', 'indresi', 'indext', 'conyuemp', 'indfall', 'tipodom', 'ind_actividad_cliente', 'segmento', 'antiguedad', 'pais_residencia', 'canal_entrada', 'ind_cco_fin_ult1_s', 'ind_cder_fin_ult1_s', 'ind_cno_fin_ult1_s', 'ind_ctju_fin_ult1_s', 'ind_ctma_fin_ult1_s', 'ind_ctop_fin_ult1_s', 'ind_ctpp_fin_ult1_s', 'ind_deco_fin_ult1_s', 'ind_deme_fin_ult1_s', 'ind_dela_fin_ult1_s', 'ind_ecue_fin_ult1_s', 'ind_fond_fin_ult1_s', 'ind_hip_fin_ult1_s', 'ind_plan_fin_ult1_s', 'ind_pres_fin_ult1_s', 'ind_reca_fin_ult1_s', 'ind_tjcr_fin_ult1_s', 'ind_valo_fin_ult1_s', 'ind_viv_fin_ult1_s', 'ind_nomina_ult1_s', 'ind_nom_pens_ult1_s', 'ind_recibo_ult1_s']</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#slow</span>
<span class="n">result1</span> <span class="o">=</span> <span class="n">get_base_model_results</span><span class="p">(</span><span class="n">source_train</span><span class="o">=</span><span class="s1">&#39;data/interim/03_train.csv&#39;</span><span class="p">,</span>
                                <span class="n">source_test</span><span class="o">=</span><span class="s1">&#39;data/interim/03_test.csv&#39;</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;data/results/04_shift.csv&#39;</span><span class="p">)</span>
<span class="n">result12</span> <span class="o">=</span> <span class="n">get_base_model_results</span><span class="p">(</span><span class="n">source_train</span><span class="o">=</span><span class="s1">&#39;data/interim/03_train_shift6.csv&#39;</span><span class="p">,</span>
                                <span class="n">source_test</span><span class="o">=</span><span class="s1">&#39;data/interim/03_test_shift6.csv&#39;</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;data/results/04_shift6.csv&#39;</span><span class="p">)</span>
<span class="n">result12</span> <span class="o">=</span> <span class="n">get_base_model_results</span><span class="p">(</span><span class="n">source_train</span><span class="o">=</span><span class="s1">&#39;data/interim/03_train_shift12.csv&#39;</span><span class="p">,</span>
                                <span class="n">source_test</span><span class="o">=</span><span class="s1">&#39;data/interim/03_test_shift12.csv&#39;</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;data/results/04_shift12.csv&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>mean average precision = 0.022998457293851166
mean average precision = 0.021781347503090444
mean average precision = 0.020448746429794492
time: 6min 9s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Zusammenfassung">Zusammenfassung<a class="anchor-link" href="#Zusammenfassung"> </a></h2><p>Wie wir sehen ist unser initiales Resultat soweit ok. Leider können wir diese Zahl nicht direkt mit derjenigen von der Kaggle Competition vergleichen, da wir eine andere Periode vorhersagen. Zudem haben wir viele mögliche Features aussen vor gelassen. In einem echten Szenario würde wir vor allem noch mehr Datasets generieren und mit verschiedenen Lags und Features testen. Als Baseline für dieses Experiment ist das Model in Ordnung.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Export">Export<a class="anchor-link" href="#Export"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.export</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">notebook2script</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Converted 01_data_preprocess.ipynb.
Converted 02_data_Cleaning.ipynb.
Converted 03_features.ipynb.
Converted 04_base_model - Versuch CCA.ipynb.
Converted 04_base_model.ipynb.
Converted 05_xgboost_simple_ensemble.ipynb.
Converted 06_LightGBM_Federated_Learning.ipynb.
Converted 06_XGBoost_Federated_Learning.ipynb.
Converted 06_lightGBM.ipynb.
Converted Untitled.ipynb.
Converted Untitled1.ipynb.
Converted index.ipynb.
time: 177 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="ch">#!python community_learning/base_model.py</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>time: 9.42 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

